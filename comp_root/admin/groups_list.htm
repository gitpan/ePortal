%#============================================================================
%# ePortal - WEB Based daily organizer
%# Author - S.Rusakov <rusakov_sa@users.sourceforge.net>
%#
%# Copyright (c) 2001 Sergey Rusakov.  All rights reserved.
%# This program is free software; you can redistribute it
%# and/or modify it under the same terms as Perl itself.
%#
%# $Revision: 3.1 $
%# $Date: 2003/04/24 05:36:51 $
%# $Header: /home/cvsroot/ePortal/comp_root/admin/groups_list.htm,v 3.1 2003/04/24 05:36:51 ras Exp $
%#
%#----------------------------------------------------------------------------
%#
%# Description: View list of ePortal groups
%#----------------------------------------------------------------------------

<% $list->draw_list %>



%#=== @metags onStartRequest ====================================================
<%method onStartRequest><%perl>
  $search_object = new ePortal::Dual::SimpleSearch;
  $search_object->handle_request( objid => $ENV{SCRIPT_NAME} );

  $obj = new ePortal::epGroup(
    SQL => "SELECT epGroup.*, count(epUsrGrp.username) as users_count
            FROM epGroup
            LEFT JOIN epUsrGrp on epGroup.groupname=epUsrGrp.groupname
    ",
    GroupBy => 'epGroup.groupname',
    );

  $list = new ePortal::HTML::List(obj => $obj, class => "smallfont", edit_url => 'groups_edit.htm', );
	$list->add_column_image();
	$list->add_column( id => "groupname", url	=> "groups_edit.htm?objid=#id#");
	$list->add_column( id	=> "groupdesc");
  $list->add_column( id => "users_count", title => pick_lang(rus => "Пользователей", eng => 'Users'), align => 'center');
  $list->add_column_system(
    delete  => 1, edit=>1);

  my $location = $list->handle_request;
  return $location if $location;

  my @where;
  if ( $search_object->Text ne '' ) {
    my $a = $search_object->Text;
    push @where, "groupname like '$a%' OR groupdesc like '$a%'";
  }

  $list->{obj}->restore_where($list->restore_parameters, where => \@where);
</%perl></%method>


%#=== @METAGS attr =========================================================
<%attr>
Title => {rus => "Список групп пользователей ePortal", eng => "Users groups of ePortal"}
</%attr>

%#=== @METAGS flags =========================================================
<%flags>
inherit => "autohandler_users.mc"
</%flags>


%#=== @metags once =========================================================
<%once>
my ($list, $obj);
our($search_object);
</%once>

%#=== @metags cleanup =========================================================
<%cleanup>
($list, $obj) = ();
($search_object)=();
</%cleanup>




%#=== @metags MenuItems ====================================================
<%method MenuItems><%perl>
  return [
  @{$m->comp("PARENT:MenuItems")},
  ["---" => "---"],
  ["" => ""],
  ["html" => $search_object->draw_dialog() ],
  ];
</%perl></%method>



%#============================================================================
%# ePortal - WEB Based daily organizer
%# Author - S.Rusakov <rusakov_sa@users.sourceforge.net>
%#
%# Copyright (c) 2001 Sergey Rusakov.  All rights reserved.
%# This program is free software; you can redistribute it
%# and/or modify it under the same terms as Perl itself.
%#
%# $Revision: 3.2 $
%# $Date: 2003/04/24 05:36:52 $
%# $Header: /home/cvsroot/ePortal/comp_root/catalog/links.htm,v 3.2 2003/04/24 05:36:52 ras Exp $
%#
%#----------------------------------------------------------------------------
%# Parameters:
%#    group=<id> display this group
%#
%#----------------------------------------------------------------------------
<%perl>
  my $html_ring  = $m->scomp('SELF:drawRing', group => $ARGS{group});
  my $html_links = $m->scomp('SELF:drawLinks', group => $ARGS{group});

  # Show Links section if a link exists or user may add new link
  # $links_count is initialized by drawLinks method
  if ( $links_count or $ePortal->isAdmin ) {
    $m->print($html_ring);
    $m->print($html_links);
  }
</%perl>



%#=== @metags drawRing ====================================================
<%method drawRing>
<table border=0 bgcolor="#FFEEEE" width="100%"><tr>
<td>
 <b><% pick_lang(rus => "Ресурсы", eng => "Resources") %></b>
</td><td align="right">
 <& SELF:drawAddLink, group => $ARGS{group} &>
</td>
</tr></table>
</%method>



%#=== @metags drawLinks ====================================================
<%method drawLinks>
% my $group = $ARGS{group};

<table border=0 width="96%" align="center">
<%perl>
  $links_count = 0;
	my $catalog = new ePortal::Catalog;
  $catalog->restore_where(parent_id => $group,
          # skip text column to avoid large traffic from SQL server
          skip_attributes => ['text'],
          recordtype => "not in('group')");
	while($catalog->restore_next) {
    $links_count ++;
    $m->comp("SELF:drawLink", link => $catalog);
  }
  undef $catalog;
</%perl>
</table>

% if ($links_count == 0) {
  <div style="font-size: 8pt; color:red; text-indent: 20px;">
  <% img(src=> "/images/ePortal/item.gif") %>
  <% pick_lang(
      rus => "Нет ни одного ресурса в этом разделе.",
      eng => 'There is no resources in this group.' ) %>
  </div>
% }
<p>
</%method>



%#=== @metags drawAddLink ====================================================
<%method drawAddLink><%perl>
    # Create dummy Catalog object with parent of current group
    my $dummy = new ePortal::Catalog;
    $dummy->parent_id( $ARGS{group} );
    if ($dummy->xacl_check_insert) {
      </%perl>
      <% plink(pick_lang(
          rus => "Добавить ресурс",
          eng => "New resource"),
          href => href("/catalog/link_edit_type.htm", parent_id => $ARGS{group})) %>
%   }
</%method>



%#=== @metags drawLink ====================================================
%# drawLink draws a link information inside a <TR>
%# It recognizes all types of RecordType of Catalog and draws accordingly
%#
<%method drawLink><%perl>
my $link = $ARGS{link};
my $highlight = $ARGS{highlight};

my $link_Title = $link->Title;
my $link_URL   = $link->URL;
my $link_Memo  = $link->Memo;
my $link_BeforeTitle = undef;

if ( $highlight ) {
  use locale;
  $link_Title =~ s/($highlight)/<span style="color:red;font-weight:bold;">$1<\/span>/i;
  $link_URL   =~ s/($highlight)/<span style="color:red;font-weight:bold;">$1<\/span>/i;
  $link_Memo  =~ s/($highlight)/<span style="color:red;font-weight:bold;">$1<\/span>/i;
}

my $linkImage = undef;
if ( $link->xacl_read eq 'everyone' ) {
  $linkImage = '/images/ePortal/item.gif';
} else {
  $linkImage = '/images/ePortal/private.gif';
}

if ( $link->RecordType eq 'group' ) {
  $linkImage = '/images/icons/icoFolder.gif';
  $link_BeforeTitle = pick_lang(rus => 'Раздел:&nbsp;', eng => 'Group:&nbsp;');

} elsif ( $link->RecordType eq 'file' ) {
  if ( $link->Filename =~ /\.doc$/i ) {
    $linkImage = '/images/icons/word.gif';
  } elsif ( $link->Filename =~ /\.xl[sw]?$/i ) {
    $linkImage = '/images/icons/excel.gif';
  } elsif ( $link->Filename =~ /\.pdf$/i ) {
    $linkImage = '/images/icons/areader.gif';
  }

  $link_BeforeTitle = pick_lang(rus => 'Файл:&nbsp;', eng => 'File:&nbsp;');
  $link_URL = $link->Filename;
  $link_URL = undef if $link_Title eq $link_URL;

} elsif ($link->RecordType =~ /^text/) {
#  $link_URL = pick_lang(rus => 'Текст', eng => 'Text') . '&nbsp;' . length($link->Text);
}

</%perl>
<tr><td width=16>
  <% img(src=> $linkImage) %>
</td><td class="smallfont">
  <% $link_BeforeTitle %><a class="smallbold" href="go.htm?link=<% $link->id %>"><% $link_Title %></a>
% if ($link_URL) {
   - <span style="font-size:8pt;color:#999999"><% $link_URL %></span>
% }
% if ($link->RecordType eq 'file') {
   <% plink(pick_lang(rus => 'Сохранить', eng => 'Download'),
      -href => href('download.htm/' . $link->Filename, link => $link->id, todisk => 1)) %>
% }
% if ($link->xacl_check_update) {
     <% icon_tool('LinkMenu', $link->id) %>
% }
% if ($link_Memo) {
  <br><span class="memo"><% $link_Memo %></span>
% }
</td></tr>
</%method>


%#=== @METAGS once =========================================================
<%once>
my $links_count = 0;
</%once>

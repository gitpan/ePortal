<HTML>
<HEAD>
<TITLE>ePortal::ThePersistent::Base - Base class for storage objects</TITLE>
<LINK REV="made" HREF="mailto:rusakov_sa@users.sourceforge.net">
</HEAD>

<BODY>

<A NAME="__index__"></A>
<!-- INDEX BEGIN -->

<UL>

	<LI><A HREF="#name">NAME</A></LI>
	<LI><A HREF="#synopsys">SYNOPSYS</A></LI>
	<LI><A HREF="#methods">METHODS</A></LI>
	<UL>

		<LI><A HREF="#new%28%29"><CODE>new()</CODE></A></LI>
		<LI><A HREF="#initialize%28%29"><CODE>initialize()</CODE></A></LI>
		<LI><A HREF="#datastore%28%29"><CODE>datastore()</CODE></A></LI>
		<LI><A HREF="#attribute%28%29"><CODE>attribute()</CODE></A></LI>
		<LI><A HREF="#attributes%28%29"><CODE>attributes()</CODE></A></LI>
		<LI><A HREF="#add_attribute%28%29"><CODE>add_attribute()</CODE></A></LI>
		<LI><A HREF="#value%28%29"><CODE>value()</CODE></A></LI>
		<LI><A HREF="#clear%28%29"><CODE>clear()</CODE></A></LI>
		<LI><A HREF="#update%28%29"><CODE>update()</CODE></A></LI>
		<LI><A HREF="#save%28%29"><CODE>save()</CODE></A></LI>
		<LI><A HREF="#restore%28%29"><CODE>restore()</CODE></A></LI>
		<LI><A HREF="#restore_all%28%29"><CODE>restore_all()</CODE></A></LI>
		<LI><A HREF="#restore_next%28%29"><CODE>restore_next()</CODE></A></LI>
		<LI><A HREF="#data%28%29"><CODE>data()</CODE></A></LI>
		<LI><A HREF="#insert%28%29"><CODE>insert()</CODE></A></LI>
		<LI><A HREF="#delete%28%29"><CODE>delete()</CODE></A></LI>
		<LI><A HREF="#delete_where%28%29"><CODE>delete_where()</CODE></A></LI>
		<LI><A HREF="#restore_where%28%29"><CODE>restore_where()</CODE></A></LI>
		<LI><A HREF="#add_where%28%29"><CODE>add_where()</CODE></A></LI>
		<LI><A HREF="#where%28%29"><CODE>where()</CODE></A></LI>
		<LI><A HREF="#validate%28%29"><CODE>validate()</CODE></A></LI>
	</UL>

	<LI><A HREF="#private%20methods">PRIVATE METHODS</A></LI>
	<UL>

		<LI><A HREF="#_check_dbi_error%28%29"><CODE>_check_dbi_error()</CODE></A></LI>
		<LI><A HREF="#dbh%28%29"><CODE>dbh()</CODE></A></LI>
		<LI><A HREF="#_id%28%29"><CODE>_id()</CODE></A></LI>
		<LI><A HREF="#check_id%28%29"><CODE>check_id()</CODE></A></LI>
	</UL>

	<LI><A HREF="#supported%20data%20types">SUPPORTED DATA TYPES</A></LI>
	<UL>

		<LI><A HREF="#varchar">VarChar</A></LI>
		<LI><A HREF="#number">Number</A></LI>
		<LI><A HREF="#datetime">DateTime</A></LI>
		<LI><A HREF="#date">Date</A></LI>
		<LI><A HREF="#yesno">YesNo</A></LI>
	</UL>

	<LI><A HREF="#internal%20variables">INTERNAL VARIABLES</A></LI>
	<UL>

		<LI><A HREF="#storage%20related%20variables">Storage related variables</A></LI>
		<LI><A HREF="#attributes">Attributes</A></LI>
		<LI><A HREF="#other%20variables">Other variables</A></LI>
	</UL>

	<LI><A HREF="#attribute%20parameters">ATTRIBUTE PARAMETERS</A></LI>
</UL>
<!-- INDEX END -->

<HR>
<P>
<H1><A NAME="name">NAME</A></H1>
<P>ePortal::ThePersistent::Base - Base class for storage objects</P>
<P>
<HR>
<H1><A NAME="synopsys">SYNOPSYS</A></H1>
<P>This package is used for handy work with database objects: SELECT, UPDATE,
INSERT, DELETE.</P>
<P>
<HR>
<H1><A NAME="methods">METHODS</A></H1>
<P>
<H2><A NAME="new%28%29"><CODE>new()</CODE></A></H2>
<P>Object constructor. Parameters:</P>
<UL>
<LI><STRONG><A NAME="item_Attributes">Attributes</A></STRONG><BR>

HASHREF or ARRAYREF to attributes description hashes. You can also add
attributes later with <A HREF="#add_attribute%28%29">add_attribute()</A>.
<P></P>
<LI><STRONG><A NAME="item_Where">Where</A></STRONG><BR>

Obligatory WHERE clause for SQL statements. Added to every SQL statement.
<P></P>
<LI><STRONG><A NAME="item_other_parameters">other parameters</A></STRONG><BR>

See <A HREF="#storage%20related%20variables">Storage related variables</A> for details.
<P></P></UL>
<P>Returns new blessed and initialized object.</P>
<P>
<H2><A NAME="initialize%28%29"><CODE>initialize()</CODE></A></H2>
<P>Object initialization block, called from <CODE>new()</CODE> constructor. <CODE>initialize()</CODE>
is used for attributes initialization. It is the place to override in
inherited modules to add its own attributes.</P>
<P><CODE>initialize()</CODE> calls <CODE>datastore()</CODE> with all passed parameters.</P>
<P>Parameters are the same as for <A HREF="#new%28%29">object constructor</A>. Only Attributes
parameter is used internally.</P>
<P>Returns none.</P>
<P>
<H2><A NAME="datastore%28%29"><CODE>datastore()</CODE></A></H2>
<P>It is the place to initialize database related things like DBH connection.
Called from <A HREF="#new%28%29">new()</A> constructor.</P>
<P>Should not be called directly.</P>
<P>Parameters are the same as for <A HREF="#new%28%29">object constructor</A>. See <A HREF="#storage%20related%20variables">Storage related variables</A> for more details.</P>
<P>Returns newly created database handle.</P>
<P>
<H2><A NAME="attribute%28%29"><CODE>attribute()</CODE></A></H2>
<P>Returns named attribute parameters as hash. In scalar context returns
hash ref.</P>
<P>If attribute does not exists then undef is returned. This method is used to
check attribute existance.</P>
<UL>
<LI><STRONG><A NAME="item_attribute_name">attribute name</A></STRONG><BR>

Name of attribute to return.
<P></P></UL>
<P>
<H2><A NAME="attributes%28%29"><CODE>attributes()</CODE></A></H2>
<P>Returns names of ALL attributes of the object as array.</P>
<P>
<H2><A NAME="add_attribute%28%29"><CODE>add_attribute()</CODE></A></H2>
<P>Add an attribute to the object. Attribute information is used when SQL
statement is constructed or when attribute datatype is needed to know.</P>
<UL>
<LI><STRONG><A NAME="item_name">name</A></STRONG><BR>

<LI><STRONG><A NAME="item_hashref">hashref</A></STRONG><BR>

HASHREF if a hash with a description of attribute type, datatype
parameters, and visualization parameters. See <A HREF="#attribute%20parameters">Attribute Parameters</A> for details.
<P></P></UL>
<P>Returns none.</P>
<P>
<H2><A NAME="value%28%29"><CODE>value()</CODE></A></H2>
<P>Get or set the value of attribute.</P>
<UL>
<LI><STRONG>name</STRONG><BR>

Name of attribute
<P></P>
<LI><STRONG><A NAME="item_new_value">new value</A></STRONG><BR>

Optional value of attribute to set.
<P></P></UL>
<P>Returns new or current value of attribute.</P>
<P>
<H2><A NAME="clear%28%29"><CODE>clear()</CODE></A></H2>
<P>Clears (undefs) the fields of the object. This method calls
<A HREF="#value%28%29">value()</A> directly. No overloaded <CODE>value()</CODE> methods will be
triggered.</P>
<P>Returns none.</P>
<P>
<H2><A NAME="update%28%29"><CODE>update()</CODE></A></H2>
<P>Updates existing object in the datastore.</P>
<P>Returns True if UPDATE was successful.</P>
<P>
<H2><A NAME="save%28%29"><CODE>save()</CODE></A></H2>
<P>Saves the object to the data store (insert or update).</P>
<P>Returns:</P>
<P>1 if the object did previously exist in the datastore</P>
<P>0 if the object did not previously exist</P>
<P>undef on error</P>
<P>
<H2><A NAME="restore%28%29"><CODE>restore()</CODE></A></H2>
<P>Restores the object from the data store.</P>
<UL>
<LI><STRONG><A NAME="item_%2540id">@id</A></STRONG><BR>

Unique identifier assigned to the object
<P></P></UL>
<P>Returns True if the object was successfully restored and False if the
object is not found.</P>
<P>
<H2><A NAME="restore_all%28%29"><CODE>restore_all()</CODE></A></H2>
<P>Restores all the objects from the data store and optionally sorted.</P>
<UL>
<LI><STRONG><A NAME="item_order_by">order_by</A></STRONG><BR>

Optional. Sort expression for the objects in the form of an SQL ORDER BY
clause.
<P></P></UL>
<P>Returns none.</P>
<P>
<H2><A NAME="restore_next%28%29"><CODE>restore_next()</CODE></A></H2>
<P>Restores the next object from the data store that matches the query
expression in the previous restore_where or restore_all method calls.</P>
<P>Returns True if an object was restored and False if an object was not
restored - no more objects to restore</P>
<P>
<H2><A NAME="data%28%29"><CODE>data()</CODE></A></H2>
<P>Gets/Sets all data fields of an object.</P>
<UL>
<LI><STRONG><A NAME="item_%2524href">$href</A></STRONG><BR>

A reference to a hash of object data. Hash keys are named of attributes.
<P></P></UL>
<P>Returns $href - a reference to a hash of object data</P>
<P>
<H2><A NAME="insert%28%29"><CODE>insert()</CODE></A></H2>
<P>Inserts new object into datastore. If ID attribute is <A HREF="#item_auto_increment"><CODE>auto_increment</CODE></A>
then newly generated number for ID is stored in object via <A HREF="#_id%28%29">_id()</A>.</P>
<P>Returns True if INSERT was successful.</P>
<P>
<H2><A NAME="delete%28%29"><CODE>delete()</CODE></A></H2>
<P>Delete the object.</P>
<UL>
<LI><STRONG>@id</STRONG><BR>

Optional. ID of the object to delete. If omitted then current object is
deleted.
<P></P></UL>
<P>Returns True if DELETE was successful.</P>
<P>
<H2><A NAME="delete_where%28%29"><CODE>delete_where()</CODE></A></H2>
<P>Conditionaly deletes objects.</P>
<P>Note: Obligatory WHERE clause will be added</P>
<UL>
<LI><STRONG><A NAME="item_where">where</A></STRONG><BR>

WHERE clause
<P></P>
<LI><STRONG><A NAME="item_binds">binds</A></STRONG><BR>

Array of values for binding.
<P></P></UL>
<P>Returns True if DELETE was successful. May be return a number of deleted
rows?</P>
<P>
<H2><A NAME="restore_where%28%29"><CODE>restore_where()</CODE></A></H2>
<P>Execute conditional SELECT statement.</P>
<UL>
<LI><STRONG>where</STRONG><BR>

<CODE>WHERE</CODE> clause for SQL statement. It may be arrayref, than every array
element will be ANDed.
<P></P>
<LI><STRONG><A NAME="item_skip_attributes">skip_attributes</A></STRONG><BR>

ARRAYREF. Do not SELECT these attributes.
<P>ID attributes always included in SELECT.</P>
<P>Do not use both skip_attributes and only_attributes!</P>
<P></P>
<LI><STRONG><A NAME="item_only_attributes">only_attributes</A></STRONG><BR>

ARRAYREF. Include in SELECT only these attributes.
<P>ID attributes always included in SELECT.</P>
<P>Do not use both skip_attributes and only_attributes!</P>
<P></P>
<LI><STRONG><A NAME="item_count_rows">count_rows</A></STRONG><BR>

Just <CODE>count(*)</CODE> with supplied WHERE clause and return it.
<P></P>
<LI><STRONG>order_by</STRONG><BR>

<CODE>ORDER BY</CODE> clause.
<P></P>
<LI><STRONG><A NAME="item_group_by">group_by</A></STRONG><BR>

<A HREF="#item_group_by"><CODE>group_by</CODE></A> clause
<P></P>
<LI><STRONG><A NAME="item_limit_rows">limit_rows</A></STRONG><BR>

Limit a number of rows returned from server
<P></P>
<LI><STRONG><A NAME="item_limit_offset">limit_offset</A></STRONG><BR>

Limit starting row returned from server. Rows counted from 1.
<P></P>
<LI><STRONG><A NAME="item_bind">bind</A></STRONG><BR>

ARRAYREF of bind values for SQL statement.
<P></P>
<LI><STRONG><A NAME="item_other_parameter">other parameter</A></STRONG><BR>

Any other parameter passed is treated as condition to <CODE>WHERE</CODE> clause if an
attribute exists with this name. Undefined parameters are WHEREd to NULL
but empty values that eq to '' are omitted.
<P></P></UL>
<P>
<H2><A NAME="add_where%28%29"><CODE>add_where()</CODE></A></H2>
<P>Helper function. Adds another WHERE condition possible ANDed with existing
one.</P>
<UL>
<LI><STRONG>hashref</STRONG><BR>

Parameters hashref. Constructed WHERE clause will be added to {where} key
of this hash.
<P></P>
<LI><STRONG>binds</STRONG><BR>

Array of bind values. These values will be added to {bind} key of
parameters hash.
<P></P></UL>
<P>Returns none.</P>
<P>
<H2><A NAME="where%28%29"><A HREF="#item_where"><CODE>where()</CODE></A></A></H2>
<P>Get/Set obligatory WHERE clause for the object.</P>
<UL>
<LI><STRONG>where</STRONG><BR>

WHERE clause. Bindings are not supported.
<P></P></UL>
<P>Returns ñurrent where clause</P>
<P>
<H2><A NAME="validate%28%29"><CODE>validate()</CODE></A></H2>
<P>Validates internal data before insert of update. This method does nothing
and is subject to override in inherited modules.</P>
<UL>
<LI><STRONG><A NAME="item_beforeinsert">beforeinsert</A></STRONG><BR>

True if called from <A HREF="#insert%28%29">insert()</A>, False if called from
<A HREF="#update%28%29">update()</A>
<P></P></UL>
<P>Returns undef on success or human readable error message if the object is
not valid.</P>
<P>
<HR>
<H1><A NAME="private%20methods">PRIVATE METHODS</A></H1>
<P>
<H2><A NAME="_check_dbi_error%28%29"><CODE>_check_dbi_error()</CODE></A></H2>
<P>Checks for errors in DBI and croaks if an error has occurred.</P>
<UL>
<LI><STRONG><A NAME="item_error_string">error string</A></STRONG><BR>

Error string prepended to the DBI error message
<P></P></UL>
<P>
<H2><A NAME="dbh%28%29"><CODE>dbh()</CODE></A></H2>
<P>Returns the handle of the database.</P>
<UL>
<LI><STRONG><A NAME="item_new_dbh">new dbh</A></STRONG><BR>

</UL>
<P>
<H2><A NAME="_id%28%29"><CODE>_id()</CODE></A></H2>
<P>Gets/Sets the ID of the object. ID may be an array.</P>
<P>
<H2><A NAME="check_id%28%29"><CODE>check_id()</CODE></A></H2>
<P>Checks that the ID of the object is valid. That is every ID attribute is
defined.</P>
<P>
<HR>
<H1><A NAME="supported%20data%20types">SUPPORTED DATA TYPES</A></H1>
<P>
<H2><A NAME="varchar">VarChar</A></H2>
<P>
<H2><A NAME="number">Number</A></H2>
<P>
<H2><A NAME="datetime">DateTime</A></H2>
<P>
<H2><A NAME="date">Date</A></H2>
<P>
<H2><A NAME="yesno">YesNo</A></H2>
<P>
<HR>
<H1><A NAME="internal%20variables">INTERNAL VARIABLES</A></H1>
<P>
<H2><A NAME="storage%20related%20variables">Storage related variables</A></H2>
<UL>
<LI><STRONG><A NAME="item_%2524self%252D%253E%257BTable%257D">$self-&gt;{Table}</A></STRONG><BR>

Name of database table.
<P></P>
<LI><STRONG><A NAME="item_%2524self%252D%253E%257BDBH%257D">$self-&gt;{DBH}</A></STRONG><BR>

DBI database handle.
<P></P>
<LI><STRONG><A NAME="item_%2524self%252D%253E%257BSTH%257D">$self-&gt;{STH}</A></STRONG><BR>

Initialized internally. Database statement handle. Used for active SELECT
statements.
<P></P>
<LI><STRONG><A NAME="item_%2524self%252D%253E%257Bdbi_xxx%257D">$self-&gt;{dbi_xxx}</A></STRONG><BR>

{dbi_source}, {dbi_username}, {dbi_password} - three parameters to create new
DBH. This is opposite to {DBH} parameter.
<P></P>
<LI><STRONG><A NAME="item_%2524self%252D%253E%257BCreatedDBH%25">$self-&gt;{CreatedDBH}</A></STRONG><BR>

Initialized internally. True if DBH is created by myself and we need to do
disconnect(). This happens when dbi_xxx parameters are passed to
constructor.
<P>If ready to use DBH is passed to constructor then {CreatedDBH} is False.</P>
<P></P>
<LI><STRONG><A NAME="item_%2524self%252D%253E%257BAutoCommit%25">$self-&gt;{AutoCommit}</A></STRONG><BR>

True if <CODE>commit()</CODE> is needed after every update statement.
<P></P>
<LI><STRONG><A NAME="item_%2524self%252D%253E%257BSQL%257D">$self-&gt;{SQL}</A></STRONG><BR>

This is opposite to {Table}. When {SQL} is passed to constructor it is used
for SELECT statement and object become read-only.
<P></P>
<LI><STRONG><A NAME="item_%2524self%252D%253E%257BWhere%257D">$self-&gt;{Where}</A></STRONG><BR>

Obliagtory WHERE clause added to every SQL statement
<P></P>
<LI><STRONG><A NAME="item_%2524self%252D%253E%257BBind%257D">$self-&gt;{Bind}</A></STRONG><BR>

Obligatory arrayref of bind values to add to every SQL request
<P></P>
<LI><STRONG><A NAME="item_%2524self%252D%253E%257BOrderBy%257D">$self-&gt;{OrderBy}</A></STRONG><BR>

ORDER BY clause by default if not passed other to <CODE>restore_where()</CODE>
<P></P>
<LI><STRONG><A NAME="item_%2524self%252D%253E%257BGroupBy%257D">$self-&gt;{GroupBy}</A></STRONG><BR>

GROUP BY clause added to every SELECT statement with <CODE>restore_where()</CODE>
<P></P></UL>
<P>
<H2><A NAME="attributes">Attributes</A></H2>
<UL>
<LI><STRONG><A NAME="item_%2524self%252D%253E%257BMetaData%257D">$self-&gt;{MetaData}{attr}</A></STRONG><BR>

Attribute object. Every attribute object is persent here. Attributes names
are in lower case.
<P></P>
<LI><STRONG><A NAME="item_%2524self%252D%253E%257BIdAttribute">$self-&gt;{IdAttributes}-&gt;[]</A></STRONG><BR>

Array of names of ID attributes.
<P></P>
<LI><STRONG><A NAME="item_%2524self%252D%253E%257BAttributes%25">$self-&gt;{Attributes}-&gt;[]</A></STRONG><BR>

Array of names of Persistent attributes.
<P></P>
<LI><STRONG><A NAME="item_%2524self%252D%253E%257BTempAttribu">$self-&gt;{TempAttributes}-&gt;[]</A></STRONG><BR>

Array of names of Temporary attributes. Temporary attributes are not stored
in database.
<P></P></UL>
<P>
<H2><A NAME="other%20variables">Other variables</A></H2>
<UL>
<LI><STRONG>$self-&gt;{Where}</STRONG><BR>

Obligatory WHERE clause. These conditions are added to WHERE clause for
every restore_xxx().
<P></P>
<LI><STRONG><A NAME="item_%2524self%252D%253E%257BCountRows%257">$self-&gt;{CountRows}</A></STRONG><BR>

When {CountRows} is True then all SELECT fields are replaced to <CODE>count(*)</CODE>
field and consctucted WHERE clause is added. This feature is used in
<A HREF="#restore_where%28%29">restore_where()</A>
<P></P></UL>
<P>
<HR>
<H1><A NAME="attribute%20parameters">ATTRIBUTE PARAMETERS</A></H1>
<P>A lot of attribute parameters are used for description, detalization and
visualization.</P>
<UL>
<LI><STRONG><A NAME="item_type">type</A></STRONG><BR>

[ ID | Persistent | <CODE>Transient(Temporary)</CODE> ]
<P>This is field persistent state. Only first 1 character is significant.
Default is <EM>Persistent</EM>.</P>
<P></P>
<LI><STRONG><A NAME="item_dtype">dtype</A></STRONG><BR>

Data type. Must correlate with any of <A HREF="#supported%20data%20types">supported datatypes</A>. Default is <EM>Varchar</EM>.
<P></P>
<LI><STRONG><A NAME="item_label">label</A></STRONG><BR>

This label is used to make labels is dialogs.
<P></P>
<LI><STRONG><A NAME="item_header">header</A></STRONG><BR>

This is used for header of column in a table.
<P></P>
<LI><STRONG><A NAME="item_maxlength">maxlength</A></STRONG><BR>

Maximum length of the field. Default is <EM>9</EM> for Number, <EM>255</EM> for Varchar.
<P></P>
<LI><STRONG><A NAME="item_scale">scale</A></STRONG><BR>

Scale of a number. Number of digits after point.
<P></P>
<LI><STRONG><A NAME="item_fieldtype">fieldtype</A></STRONG><BR>

[textfield | popup_menu | textarea | YesNo | date | datetime]
<P>Type of dialog item used for this field. Default is <EM>textfield</EM>.</P>
<P></P>
<LI><STRONG><A NAME="item_size">size</A></STRONG><BR>

Size of field in dialog boxes in characters.
<P></P>
<LI><STRONG><A NAME="item_labels%252Cvalues">labels,values</A></STRONG><BR>

Used for popup_menu field type. <STRONG>values</STRONG> may be a coderef declared as sub
{}. The object ($self) passed to this sub as first parameter.
<P></P>
<LI><STRONG><A NAME="item_auto_increment">auto_increment</A></STRONG><BR>

This Number attribute is auto incremented by database during INSERT
operation.
<P></P>
<LI><STRONG><A NAME="item_popup_menu">popup_menu</A></STRONG><BR>

sub{ my $self=shift; ... return (\@val,\%lab);}
<P>Coderef used to fill up popup_menu parameters.</P>
<P></P>
<LI><STRONG><A NAME="item_columns%252Crows">columns,rows</A></STRONG><BR>

Used for textarea field type
<P></P>
<LI><STRONG><A NAME="item_description">description</A></STRONG><BR>

Not used
<P></P></UL>

</BODY>

</HTML>
